
- [1. 适用性](#1-适用性)
  - [1.1 语言规范性](#11-语言规范性)
- [2. 介绍](#2-介绍)
  - [2.1. 示例：诊断用途](#21-示例诊断用途)
  - [2.2. 示例：P2P 覆盖网络的应用](#22-示例p2p-覆盖网络的应用)
  - [2.3. 实验目标](#23-实验目标)
- [3. 操作概述](#3-操作概述)
  - [3.1. 确定 NAT 映射行为（Determining NAT Mapping）](#31-确定-nat-映射行为determining-nat-mapping)
  - [3.2. 确定 NAT 过滤行为（Determining NAT Filtering）](#32-确定-nat-过滤行为determining-nat-filtering)
  - [3.3. 绑定生存期发现（Binding Lifetime Discovery）](#33-绑定生存期发现binding-lifetime-discovery)
  - [3.4. 诊断 NAT 回环（Diagnosing NAT Hairpinning）](#34-诊断-nat-回环diagnosing-nat-hairpinning)
  - [3.5. 确定 NAT 对数据包分片的处理方式（Determining Fragment Handling）](#35-确定-nat-对数据包分片的处理方式determining-fragment-handling)
  - [3.6. 检测 NAT 设备的通用应用层网关（ALG）（Detecting a Generic Application Level Gateway, ALG）](#36-检测-nat-设备的通用应用层网关algdetecting-a-generic-application-level-gateway-alg)
- [4. 发现过程](#4-发现过程)
  - [4.1 源端口选择](#41-源端口选择)
  - [4.2. 使用 STUN 服务器检查 UDP 连接性](#42-使用-stun-服务器检查-udp-连接性)
  - [4.3. 确定 NAT 映射行为](#43-确定-nat-映射行为)
  - [4.4. 确定 NAT 过滤行为](#44-确定-nat-过滤行为)
  - [4.5. 结合与优化测试](#45-结合与优化测试)
  - [4.6. 绑定生命周期发现](#46-绑定生命周期发现)
- [5. 客户端行为](#5-客户端行为)
- [5.1 发现（Discovery）](#51-发现discovery)
- [5.2 安全（Security）](#52-安全security)
- [6. 服务器行为](#6-服务器行为)
- [6.1 准备响应（Preparing the Response）](#61-准备响应preparing-the-response)
  - [`Binding Response` 的源地址和端口](#binding-response-的源地址和端口)
  - [其他属性](#其他属性)
  - [其他处理](#其他处理)
- [7. 新属性](#7-新属性)
  - [7.1. 传输地址的表示](#71-传输地址的表示)
  - [7.2. CHANGE-REQUEST](#72-change-request)
  - [7.3. RESPONSE-ORIGIN](#73-response-origin)
  - [7.4. OTHER-ADDRESS](#74-other-address)
  - [7.5. RESPONSE-PORT](#75-response-port)
  - [7.6. PADDING](#76-padding)

## 1. 适用性

此实验性 STUN 的 NAT 行为发现（NAT Behavior Discovery）用法可提供NAT设备的可观测瞬时行为信息；它能针对测试运行时使用的STUN服务器及特定客户端端口，确定NAT的瞬时行为特征。此STUN用法不允许NAT后的应用程序对NAT的特性做出绝对判断。NAT设备的行为不够一致，无法保证预测未来的行为。需要两个特定端点之间可靠通信的应用程序必须使用另一种技术通过NAT建立通信通道。IETF已提出包括 [[RFC5245]]() 和 [[RFC5626]]() 在内的标准，用于在可公开访问的会合服务可用时建立通信通道。

本文档中STUN属性的预期用途是应用程序的诊断和实时调优。例如，确定哪些方法可能有效并应首先尝试，而不是更昂贵的方法。这些属性还可用于观察导致应用程序通信失败的行为，从而更好地选择恢复方法。STUN属性也可以作为网络技术人员的诊断工具的基础，以观察NAT行为。

本文档提出了在无法公开访问会合服务的情况下，实时优化协议参数的实验性用法。只有在结果被用作优化并且有可靠的备用方案时，这些技术的使用才是可能的，以防NAT的行为比行为发现测试确定的更为严格。一个可能的应用是基于建立直接连接和诊断与各种对等体的NAT行为的统计经验，在点对点（P2P）网络中选择角色。实验性问题是这样的测试是否有用。考虑一个节点试图作为完整对等体加入覆盖网络，但其NAT阻止了足够的连接性；加入和退出覆盖网络可能代价高昂，并可能导致不可靠或性能不佳的操作。即使行为发现检查只有75%的时间是“正确的”，其相对低廉的成本可能使其在优化覆盖网络行为方面非常有用。第[2.2节]()更详细地描述了这一实验性应用，并讨论了如何评估其成功或失败。

此STUN用法的应用与STUN的原始用途（最初为RFC 3489 [[RFC3489]]()，现为RFC 5389 [[RFC5389]]()）不同。本规范承认在此用法中收集的信息并非也不可能100%正确，而STUN仅专注于获取已知正确且静态的信息。

本规范也可以与ICE进行比较。ICE要求必须有一个回退到TURN的选项，而基于RFC 3489的应用程序试图提前确定是否需要中继以及它们的对等反射地址将是什么，这通常无法实现。

此STUN用法要求使用它的应用程序有一个备用方案。然而，与ICE关注于VoIP会话中固有的问题不同，此STUN用法并不假设它将用于在单对机器之间建立连接，因此可能有其他备用机制可用。

例如，在P2P应用程序中，如果对等体发现实际上10%的连接尝试失败，可能可以简单地切换到不需要建立此类连接的角色，或选择替代的间接路由。

它作为实验性协议提交给互联网社区，当应用适当的统计基础和最终基于经验连接模式的应用程序行为时，可以比没有它提供的知识时带来更多的稳定性和更高的性能。

如果标准跟踪文档指定了此STUN用法的任何部分的使用，则该文档必须描述如何管理使用这些方法得出的错误信息，无论是通过识别NAT行为何时发生变化，还是因为协议使用此类知识作为优化，但在NAT行为变化时仍保持功能。引用文档还必须定义何时调用备用机制。不同领域的应用程序在备用机制的使用激进程度上可能差异很大，因此必须明确定义何时调用备用机制。


### 1.1 语言规范性
本文件中的关键词"必须(MUST)"、"不得(MUST NOT)"、"必需(REQUIRED)"、"应(SHALL)"、"不应(SHALL NOT)"、"宜(SHOULD)"、"不宜(SHOULD NOT)"、"推荐(RECOMMENDED)"、"可以(MAY)"和"可选(OPTIONAL)"，应按照RFC 2119 [[RFC2119]]()所述进行解释。


## 2. 介绍

 "Session Traversal Utilities for NAT (STUN)" [[RFC5389]]() 提供了一种机制，允许使用 **绑定请求（Binding Request）** 发送到 STUN 服务器 来发现 **自反传输地址（Reflexive Transport Address）**。本规范定义了 STUN 的 **NAT 行为发现（NAT Behavior Discovery）**  用法，使 STUN 客户端能够探测 NAT/防火墙（NAT/FW）设备在客户端与 STUN 服务器之间的当前行为。本用法为绑定请求和绑定响应定义了新的 STUN 属性。  

许多 NAT/FW 设备的行为并不一致，并且可能会随着负载变化和时间推移而发生变化。对于要求高可靠性的应用程序来说，必须考虑到 NAT 的行为可能变得更加严格。具体而言，研究发现，在高负载情况下，NAT 可能会转变为 **最严格的过滤和映射行为**，并缩短新建和现有会话绑定的生命周期。简而言之，应用程序可以探测当前的网络状况是否恶劣，但无法预测未来会变得多糟糕。  

尽管存在这一限制，即无法预测未来 NAT 行为的变化，但 **即时观察** 仍然在网络故障排除中非常有用。此外，**在不同时间或特定负载条件下进行重复测试**，可以帮助刻画 NAT 的行为特征。特别是，当这些测试由熟悉应用需求的人员执行时，并且了解应用需要与哪些节点通信时，它可以成为一种强大的工具。  



### 2.1. 示例：诊断用途

在实验室环境中运行良好的应用程序，可能在实际部署时出现故障，这是 **分布式系统中常见的问题**。几乎所有系统开发人员都曾遇到过这种情况：试图找出测试环境与真实网络环境的差异，以理解实验中未能发现的网络行为问题。NAT 行为发现（NAT Behavior Discovery）提供了一种强大的工具，**可以在应用程序运行时检查 NAT 和防火墙的行为**。  

例如，一个应用程序可以被设计为在遇到 **重大通信问题** 时执行 **行为发现测试**。这种分析还可以作为应用程序日志的一部分，记录诊断信息。  

由于 NAT 行为发现 STUN 用法用于检测**即时行为**，并供有经验的开发人员或管理员进行分析，因此对其应用的担忧相对较少。然而，用户仍需注意以下事项：  

- **向新目的地（STUN 服务器）发送新流量，可能会改变 NAT 的行为**。  
- **用户应谨慎选择 STUN 服务器的位置**，最好选择与应用的通信对象**同地**（甚至直接集成），以确保测试结果能准确反映应用所经历的网络条件。  



### 2.2. 示例：P2P 覆盖网络的应用

应用程序可以在P2P 协议中使用 NAT 行为发现（NAT Behavior Discovery），以确定某个端点是否适合充当 **对等节点（peer）或超级节点（supernode）**。这里，**超级节点** 指的是**可以为 P2P 覆盖网络提供服务（例如消息路由）的节点**。  

P2P 网络应用通常希望选择 **位于 NAT 之后的超级节点**，以避免使用专用服务器的额外成本。而要成为超级节点，NAT 设备必须支持 **端点独立过滤（Endpoint-Independent Filtering）**。应用程序可以定期重新运行测试，如果发现 NAT/FW 设备不再具备该特性，则应自动**退出超级节点角色**。这些测试可以使用其他超级节点作为 STUN 服务器，或者直接使用专门的 STUN 服务器。  

由于许多 P2P 算法能够容忍部分节点之间的 **非传递性连接（non-transitive connectivity）**，因此它们可能会牺牲点对点（pair-wise）的可靠连接，以便将 P2P 网络的负载分布到更多可直接被多数用户访问的节点上。  


让我们更详细地探讨一个假设的 P2P 协议示例：  

- 当 **P2P 节点 A 启动** 时，它会相对于 **已经在覆盖网络中的其他对等节点** 测试自己的 NAT 行为。  
- 如果测试结果表明 A 处于一个 **“良好” NAT** 之后（即支持 **端点独立映射（Endpoint-Independent Mapping）和端点独立过滤（Endpoint-Independent Filtering）**），那么 A 将加入 P2P 覆盖网络，并与适当的对等节点建立连接，以形成 P2P 网络的拓扑结构。  
- 尽管 A **可以通过覆盖网络的路由机制进行通信**，但它也会在通信中告诉其他节点，它们可以 **直接使用 A 在初始测试中发现的自反 IP 地址（Reflexive IP Address）** 进行联系。  

假设之后，**节点 B 想要向 A 发送消息**，但 B **并不是 A 在 P2P 拓扑中的直接邻居**，那么 B **可能会直接向 A 的 IP 地址发送消息**，同时启动一个计时器。如果 B **在规定时间内未收到 A 的响应**，那么它会 **改为通过 P2P 覆盖网络路由消息给 A**，并在消息中添加一个标志，指示 **尝试直接连接失败**。  
（另一种替代方案是，B **同时** 通过 A 的 IP 地址和 P2P 覆盖网络发送消息，这样可以**最小化响应延迟**，但会浪费带宽。）  

随着时间推移，**A 统计它接收到的直接消息占所有尝试直接消息的成功率**。如果成功率低于某个阈值（例如 **75%**），那么 A 可能会 **停止公布自己的直接连接信息**，因为它已经通过实际运行数据确定其 NAT **无法提供足够稳定的直接连接**，尝试直接消息的成本**不值得**。  

但如果成功率 **足够高**，A **仍然会继续公布其自反地址**，因为 **成功的直接连接有助于降低 P2P 网络的路由负载，从而提升整个覆盖网络的性能**。  

如果某个时间点，A **的 NAT 行为发生了变化**，它会注意到 **直接连接的成功率发生变化**，并可能重新评估 **是否继续公布其公网地址**。在这个假设的场景中，**行为发现（Behavior Discovery）** 用于 A **初始运行模式的选择**，但是否 **继续公布公网 IP/端口对** 的决策则是基于 **实际运行数据** 进行动态调整的。  

此外，**行为发现的结果** 还可用于**优化 P2P 网络的性能**。因为无论如何，**A 始终可以通过 P2P 覆盖网络与其他节点建立连接**，即使 **直接连接尝试失败**。  





在这种应用场景下，使用 NAT 行为发现（NAT Behavior Discovery）需要满足以下要求：  

- **协议必须能够在不可靠的点对点连接上提供稳定的终端用户体验**。  
- **协议必须提供可靠的回退机制**，即当基于行为发现的直连尝试失败时，仍然能保证通信。  
- **应用程序必须部署在支持端点独立过滤（Endpoint-Independent Filtering）的 NAT 之后**，并且 NAT **在足够长的时间内保持这种行为**，使得应用程序能够识别 NAT 的行为、在 P2P 网络中传播该信息，并确保这些信息对应用程序仍然有用。  

由于当前还没有在 **开放协议的应用程序** 中大规模部署此功能来验证这些要求是否被满足，因此本文件被归类为 **实验性（experimental）** 规范。然而，**从实际观察来看**，家庭和小型企业使用的 NAT 设备通常表现出 **稳定的行为**，特别是在 **后面只有少量客户端** 的情况下。  

许多 P2P 应用程序已经被部署，并表现出 **类似的特性**，但它们的协议尚未经过 **标准化机构的严格评估**。  



### 2.3. 实验目标  

要成功证明 **STUN 的 NAT 行为发现（NAT Behavior Discovery） 用法的有效性**，应用程序需要满足以下条件：  

- **实现一个依赖该用法的系统，以决定其运行时行为**。最有可能的方式是：  
  - **使用 NAT 行为发现来确定初始运行模式**，然后  
  - **根据后续的网络连接体验进行动态调整**。  
- **在合理的部署环境中证明其实用性**。  
  - **例如**，该实现可以假设服务提供商会部署多个 **IP 地址的专用 STUN 服务器**，或者  
  - 证明该应用 **可以用两个节点共享角色** 来模拟这样的 STUN 服务器，从而完成 **地址变化相关的 NAT 绑定测试**。  
- **提供实验数据，证明该用法能够在真实世界环境中改善应用的表现**。  
  - **可能的衡量指标包括**：  
    - 更快地收敛到合适的参数配置  
    - 更少的初始连接建立工作量  
    - 启动后所需的重新配置次数减少  
    - 其他可能的优化效果  
- **提供一个协议规范，定义如何使用该用法**。  

上述的 **P2P 网络测试场景** 是该用法的一个 **潜在实验用例**，但并不局限于此，其他应用场景也是可能的。

## 3. 操作概述

在典型的配置中，**STUN 客户端** 连接到 **私有网络**，并通过一个或多个 **NAT 设备** 连接到 **公网**。客户端配置了 **公网 STUN 服务器的地址**。**行为发现（Behavior Discovery）** 使用 **SRV 记录**，这样服务器可以为该用途指定不同的 **传输地址（Transport Address）**，而不影响 STUN 的其他用途。该用法**不兼容** RFC 3489 [[RFC3489]]() 的客户端或服务器。  
- **希望兼容 RFC 3489 服务器的客户端实现者** 应参考该规范。  
- **服务器实现者不应支持 RFC 3489 客户端**，因为该协议的原始用途已被废弃。  

由于 **STUN 规范禁止服务器主动创建新的 TCP 或 TCP/TLS 连接到客户端**，因此 **大多数测试仅适用于 UDP**。每种测试的适用性将在后文说明。  

STUN 的 NAT 行为发现（NAT Behavior Discovery）用法在 **STUN 绑定请求（STUN Binding Request）** 和 **STUN 绑定响应（STUN Binding Response）** 中定义了新的**属性（Attributes）**，这些消息用于 **诊断 NAT 设备的当前行为**。  

本节提供了这些属性的 **描述性概述**，具体的规范行为在 第 [5]()、[6]()、[7]() 节 中详细定义。  



### 3.1. 确定 NAT 映射行为（Determining NAT Mapping）

客户端想要确定其 NAT **当前使用的映射模式**：  
1. **端点独立映射（Endpoint-Independent Mapping）**  
2. **地址相关映射（Address-Dependent Mapping）**  
3. **地址与端口相关映射（Address and Port-Dependent Mapping）**  

客户端会执行一系列测试，这些测试利用了 **OTHER-ADDRESS 属性**（详细描述见 [第 4 节]()）。  
- 这些测试涉及向 STUN 服务器的 **备用地址（Alternate Address）** 和 **端口** 发送绑定请求，以确定 NAT 的映射行为。  
- 适用于 **UDP、TCP 和 TCP/TLS 连接**。  



### 3.2. 确定 NAT 过滤行为（Determining NAT Filtering）

客户端希望确定其 NAT **当前使用的过滤模式**：  
1. **端点独立过滤（Endpoint-Independent Filtering）**  
2. **地址相关过滤（Address-Dependent Filtering）**  
3. **地址与端口相关过滤（Address and Port-Dependent Filtering）**  

客户端执行一系列测试，利用了 **OTHER-ADDRESS** 和 **CHANGE-REQUEST 属性**（详见 **第 4 节**）。  
- 这些测试会请求 STUN 服务器的 **备用地址和端口** 进行响应。  
- **测试的前提条件**：**客户端与备用地址和端口之间尚未建立绑定**。  
- 由于 NAT **不会识别备用地址和主地址属于同一 STUN 服务器**，因此它会将其视为互联网中的普通主机。  
- 备用地址和端口的响应成功与否，决定了 NAT **使用哪种过滤模式**。  

**适用于 UDP 数据包**（不适用于 TCP/TLS）。  



### 3.3. 绑定生存期发现（Binding Lifetime Discovery）

许多系统（例如 **VoIP**）需要 **保持客户端和服务器之间的连接**，或者 **保持 P2P 系统中的对等节点连接**。  
- 由于 NAT **会定期删除空闲的映射绑定**，因此 **需要发送心跳消息（Keepalive）** 以维持连接。  
- 但心跳消息会增加 **网络和服务器的负担**，因此**减少心跳频率** 是有益的。  

**问题：**  
- 传统的 **请求-响应协议** 无法直接测试 NAT 绑定的生存期，**因为请求本身会重置 NAT 的绑定计时器**。  

**解决方案：**  
- **行为发现** 定义了 **RESPONSE-PORT 属性**，使客户端和服务器可以 **通过一个端口（控制通道）测试另一个端口的 NAT 绑定生存期**。  
- 客户端使用 **第二个端口** 和 **STUN 服务器的备用地址** 进行测试，检查 **T 时间后未发送数据的绑定是否仍然有效**（详见 **第 4.6 节**）。  

**适用于 UDP 数据包**（不适用于 TCP/TLS）。  



### 3.4. 诊断 NAT 回环（Diagnosing NAT Hairpinning）

**NAT 回环（Hairpinning）** 指的是 **NAT 设备是否允许内部主机访问自己在公网映射的地址**。  

**测试方法：**  
1. 客户端 **先向 STUN 服务器发送绑定请求**，以获取其 **映射地址（Mapped Address）**。  
2. 客户端 **再从另一个端口向该映射地址发送 STUN 绑定请求**。  
3. 如果客户端 **能收到自己的请求**，则说明 NAT **支持回环**。  

**适用于 UDP、TCP 和 TCP/TLS 连接**。  



### 3.5. 确定 NAT 对数据包分片的处理方式（Determining Fragment Handling）

部分 NAT 设备在处理 **数据包分片（Fragmentation）** 时表现不同于处理完整数据包。例如：  
- **某些 NAT 不会对分片数据包执行回环（Hairpinning）**。  
- **某些设备在高负载情况下会丢弃分片数据包**。  

**测试方法：**  
- STUN 消息可以使用 **PADDING 属性**，该属性在消息中插入额外的填充数据，以 **强制 STUN 消息被分片**，从而观察 NAT 的行为。  
- 所有先前的测试都可以在 **开启 PADDING** 后重新执行，以检测 NAT 的 **分片处理方式**。  
- 也可以仅针对对应用最重要的测试使用 PADDING。  

**适用于 UDP 数据包**（不适用于 TCP/TLS）。  
**PADDING 不能与 RESPONSE-PORT 组合使用**。  



### 3.6. 检测 NAT 设备的通用应用层网关（ALG）（Detecting a Generic Application Level Gateway, ALG）

**通用 ALG（Application Level Gateway）** 是一种 NAT 设备，它会主动 **检测并修改** 网络数据包中的 **IP 地址**（无论是 **文本格式** 还是 **二进制格式**）。  

**检测方法：**  
- **STUN 服务器在同一响应中返回两个地址**：
  1. **MAPPED-ADDRESS（直接映射地址）**
  2. **XOR-MAPPED-ADDRESS（异或映射地址）**  
- 如果这两个地址 **不匹配**，说明 **NAT 设备存在一个通用 ALG**，并且它修改了数据包中的 IP 地址。  

**适用于 UDP 和 TCP**（不适用于 TLS/TCP）。  

## 4. 发现过程

本节描述了 NAT 行为发现使用原语（primitives）如何进行检查，以发现应用程序所处的 NAT 或多个 NAT 的当前行为。这些测试仅能反映NAT的瞬时行为；研究发现，NAT 的行为可能会随负载和时间发生变化。因此测试结果可视为**上限值**——应用程序必须假定NAT行为随时可能变得更加严格。此外，使用客户端特定端口获得的测试结果也可能无法反映其他端口的NAT行为，如 [4.1]() 节所述。

NAT过滤(filtering)与映射(mapping)行为的定义源自[[RFC4787]]()。本文描述的测试涉及 UDP 连接性、NAT 映射行为、NAT 过滤行为和 NAT 绑定生命周期发现；还可以设计其他测试，以利用该使用机制。以下测试仅适用于具有单个 IP 地址的客户端。具有多个 IP 地址的客户端（或在同一 NAT 后协作的多个客户端）可以结合其探测来测试 NAT 行为的其他方面，例如端口过载情况。本节提供了如何使用本规范中 STUN 属性所提供的原语进行行为测试的描述性概述。

有关这些属性的规范定义将在后续章节中详细说明。

### 4.1 源端口选择

正确的源端口选择对确保行为发现测试的有效性和准确性至关重要。测试有两个前提条件:

- **端口级别的映射行为可能有所不同**，因此应用程序应尽可能使用其打算用于通信的源端口执行测试。如果应用程序需要使用多个源端口，则应针对每个端口重复测试。为减少 NAT 负载，这些测试应**按顺序执行**。
  
- **某些诊断检查的结果取决于 NAT 先前的流量状态**，因此测试应使用**最近未产生流量的源端口**。应用程序应使用随机源端口，或者确保所选端口在测试前未发生任何流量，通常的方法是在测试前至少 15 分钟内分配一个端口并保持其空闲。


确保满足上述两个前提条件可能会很具挑战性，特别是对于希望在启动时执行行为发现测试的设备或应用程序。以下是减少问题可能性的建议指南：

- **应用程序不应尝试分配特定或知名端口**。由于此类软件必须设计为使用 NAT 映射的任何端口进行互操作，因此特定端口是不必要的。相反，在启动时应选择随机端口（下文将推荐端口范围）。此外，特别是在嵌入式设备上，应用程序不应依赖主机操作系统选择下一个可用端口，因为这可能会导致应用程序在每次重新启动时获得相同的端口。如果应用程序在重新启动之间使用相同的端口，则无法从测试 NAT 状态相关行为（如过滤和绑定生命周期）的行为发现测试中获得准确结果。

- **需要多个端口的应用程序（例如分别用于控制和媒体的端口）应在启动时分配这些端口**。即使暂时不需要媒体流，如果这些端口需要运行行为发现测试，则应尽早分配它们，以便它们保持空闲状态，从而提高获得准确测试结果的可能性。

- **尽管使用应用程序实际使用的端口进行测试可获得最可靠的结果，但在许多情况下，应用程序可能需要在无法对端口进行完整测试的情况下分配和使用端口**。在这种情况下，应用程序应从 NAT 可能以相同方式处理的端口范围中随机选择端口。本文建议使用以下端口范围进行随机选择：
  - **32768-49151**（IANA 注册端口范围的高端）
  - **49152-65535**（IANA 动态或私有端口范围）

  为了尝试表征 NAT 在这些范围内对端口的通用处理方式，可以从范围内随机选择少量端口并进行特征分析。

某些对 NAT 先前状态特别敏感的测试将在下文明确指出。



### 4.2. 使用 STUN 服务器检查 UDP 连接性

客户端向 STUN 服务器发送**绑定请求（Binding Request）**，服务器将响应发送到请求的来源地址和端口。如果此测试未收到响应，客户端可以立即确定其**无法与 STUN 服务器建立 UDP 连接**。此测试仅依赖于 STUN [[RFC5389]]() 的基本功能。



### 4.3. 确定 NAT 映射行为

此过程最多需要进行三次测试：

1. **测试 I**：客户端执行 UDP 连接性测试。收到绑定响应（Binding Response）后客户端检查 `XOR-MAPPED-ADDRESS` 属性：
   - 如果该地址和端口与客户端用于发送请求的本地 IP 和端口相同，则表明**客户端未经过NAT（或者 NAT 没有做地址转换）**，此时映射行为可以认为**端点独立映射（Endpoint-Independent Mapping）**，否则执行测试 II。
   - 服务器将在绑定响应（Binding Response）中的 `OTHER-ADDRESS` 字段返回备用地址和端口。如果 `OTHER-ADDRESS` 字段未返回，表示服务器不支持此功能，无法进行进一步测试。
2. **测试 II**：客户端向备用地址（但主端口）发送绑定请求。如果测试 II 返回的 `XOR-MAPPED-ADDRESS` 与测试 I 相同，则 NAT 当前具有**端点独立映射**。否则，执行测试 III。

3. **测试 III**：客户端向备用地址和备用端口发送绑定请求：
   - 如果 `XOR-MAPPED-ADDRESS` 与测试 II 匹配，则 NAT 具有**地址相关映射（Address-Dependent Mapping）**；
   - 如果不匹配，则 NAT 具有**地址和端口相关映射（Address and Port-Dependent Mapping）**。



### 4.4. 确定 NAT 过滤行为

此过程最多需要进行三次测试，且对 NAT 先前状态敏感。

1. **测试 I**：执行 UDP 连接性测试。服务器将在 `OTHER-ADDRESS` 字段返回备用地址和端口。如果 `OTHER-ADDRESS` 未返回，无法进行进一步测试。

2. **测试 II**：客户端向服务器的主地址发送绑定请求，并将 `CHANGE-REQUEST` 属性设置为 `change-port` 和 `change-IP`，这将导致服务器从备用 IP 和备用端口发送响应。
   - 如果客户端收到响应，则 NAT 当前具有**端点独立过滤（Endpoint-Independent Filtering）**。
   - 如果未收到响应，则执行测试 III。

3. **测试 III**：客户端向服务器主地址发送绑定请求，并将 `CHANGE-REQUEST` 设置为 `change-port`。
   - 如果收到响应，则 NAT 具有**地址相关过滤（Address-Dependent Filtering）**；
   - 如果未收到响应，则 NAT 具有**地址和端口相关过滤（Address and Port-Dependent Filtering）**。



### 4.5. 结合与优化测试

客户端可以合并和并行化这些测试，以减少数据包数量并加快发现过程。例如：
- 过滤和映射测试的测试 I 也可用于检查 UDP 是否被阻止。
- 一些应用程序可能不需要完整的测试，而仅需要检测 NAT 是否提供**端点独立映射**。

但需要注意：
- 某些 NAT 设备对绑定分配速率有限制，不能并行化过多测试。
- 5.0 节将限制客户端开始新 STUN 事务的速率。



### 4.6. 绑定生命周期发现

STUN 还可用于探测 NAT 绑定的**生命周期**，但此测试对 NAT 先前状态敏感。由于 NAT 可能会随负载调整绑定存活时间，应用程序应发送**定期保活（keepalives）**，确保连接保持稳定。

绑定生存期的确定依赖于两个不同的源端口用于向 STUN 服务器发送绑定请求（Binding Request）。基本方法是，客户端使用源端口 X 发送单个绑定请求。在端口 X 未被使用的一段时间后，客户端使用第二个源端口 Y 发送一个绑定请求，并指示响应应发送到端口 X 先前建立的绑定。如果 X 的绑定已超时，则不会收到该响应。通过调整从 X 发送初始绑定请求到 Y 发送后续请求之间的时间间隔，客户端可以确定绑定的生存期。

要确定绑定的生存期，客户端首先从特定的源端口 X 向服务器发送绑定请求。这将在 NAT 设备中创建一个绑定。服务器返回的响应包含 `MAPPED-ADDRESS` 属性，该属性提供 NAT 设备的公网地址和端口，分别记为 Pa 和 Pp。然后，客户端启动一个计时器，设定时间为 T 秒。当该计时器触发时，客户端从不同的源端口 Y 向服务器发送另一个绑定请求，使用相同的目标地址和端口，但该请求包含 `RESPONSE-PORT` 属性，设置为 Pp，以请求将响应发送到 (Pa, Pp)。这将在 NAT 设备上创建一个新的绑定，并使 STUN 服务器发送一个绑定响应，该响应如果旧的绑定 (Pa, Pp) 仍然存在，就会匹配该绑定。

- 如果客户端在端口 X 上接收到绑定响应，则说明绑定尚未过期。
- 如果客户端在端口 Y 上接收到绑定响应（这可能发生在旧绑定过期且 NAT 为新绑定分配了相同的公网地址和端口的情况下），或者根本未收到响应，则说明绑定已过期。

由于某些 NAT 设备仅在发送出站流量时才会刷新绑定，因此在开始使用不同的 T 值进行第二次测试之前，客户端必须先从原始源端口重新发送绑定请求。客户端可以通过对 T 进行二分搜索，最终确定一个值，使得对于大于该值的任何计时器都无法接收到响应，而对于小于该值的任何计时器都能接收到响应。此外，绑定刷新行为（仅出站流量刷新或所有流量均可刷新）也可以通过在不刷新原始源端口 X 的情况下，从端口 Y 发送多个绑定请求来确定。

该发现过程需要相当长的时间，通常是在设备启动后在后台运行。

客户端在每次运行该过程时可能会获得不一致的结果。例如，如果 NAT 设备重启或由于某种原因被重置，则此过程可能会发现一个比实际生存期更短的时间。绑定的生存期也可能取决于 NAT 设备的流量负载。因此，建议实现者多次运行该测试，并做好处理不一致结果的准备。

与其他诊断方法类似，此测试本质上也是不稳定的。特别是，当 NAT 设备负载过高时，可能会缩短绑定的生存期以减轻负载。客户端在启动时可能会发现此诊断方法有用，例如，在开始检查时，将其与服务器的连接的初始保活间隔设置为 10 秒。在确定当前生存期后，与服务器的连接可使用适当的间隔发送保活消息。随后，可以利用与服务器的连接中的保活消息执行绑定生存期的检查。STUN 保活使用方法 [RFC5626] 提供了一种响应机制，该机制可以确认连接是否仍然打开，并允许客户端检查其映射地址是否发生变化。由于此机制既能执行保活操作，又能提供确认连接可用的诊断信息，因此应优先于任何试图通过次要技术对连接进行表征的方法。




## 5. 客户端行为

除非本文档另有规定，否则所有消息的准备、发送和处理程序均应遵循 STUN 绑定使用方法 [RFC5389] 中的描述。

由于 `RESPONSE-PORT` 的支持是可选的，因此客户端必须准备好接收 420（未知属性）错误响应，以应对包含 `RESPONSE-PORT` 的请求。`OTHER-ADDRESS` 和 `CHANGE-REQUEST` 的支持是可选的，但对于通过 SRV 公布的服务器，必须支持这些属性（具体见下文）。这样可以允许在服务器不具有多个 IP 地址的情况下使用 `PADDING` 和 `RESPONSE-PORT`。如果 `Binding Response` 消息未包含 `OTHER-ADDRESS`，则客户端必须准备好接收 420 错误响应，以应对包含 `CHANGE-REQUEST` 的请求。

如果应用程序通过与应用流量复用 STUN 消息来使用 NAT 行为发现（Behavior Discovery），那么应当包含 `FINGERPRINT` 属性，**除非**可以始终基于消息头区分 STUN 消息与应用程序消息。

当使用 `PADDING` 时，其值应当等于出站接口的 MTU（最大传输单元）。

客户端应当忽略 `ALTERNATE-SERVER` 属性，除非它正在使用由熟知测试拓扑要求的 STUN 服务器提供方进行身份验证。

客户端不应每秒生成超过 10 个新的 STUN 事务，并且应当调整发送节奏，以防止重传超时（RTOs）导致多个事务的重传同步发生。



## 5.1 发现（Discovery）

除非用户或应用程序已通过其他方式获知支持 NAT 行为发现（Behavior Discovery）功能的 STUN 服务器的传输地址，否则客户端将被配置为 STUN 服务器提供方的域名。该域名通过 SRV 过程 [RFC2782] 解析为传输地址。如何配置 STUN 服务器的域名或获取特定传输地址的机制不在本文件的讨论范围之内。

对于行为发现（Behavior Discovery）用途：
- UDP 和 TCP 使用的服务名称为 `"stun-behavior"`。
- 通过 TLS 运行于 TCP 之上的服务名称为 `"stun-behaviors"`。
- `"stun-behaviors"` 仅定义 `"tcp"` 作为协议。

其他关于失败处理和默认端口的行为，应遵循 STUN [RFC5389] 的规定。



## 5.2 安全（Security）

服务器可以在允许客户端使用其服务之前要求身份验证。获取这些凭据的方法（如果服务器需要）不在本使用方法的讨论范围之内。通常，依赖该方法的管理员或应用程序应当自行管理凭据的获取方式。

如果客户端对请求收到 401（未授权）响应，则它必须（MUST）在重试前从应用程序获取适当的凭据，否则应报告永久性故障。

有关在请求中编码 `MESSAGE-INTEGRITY` 属性的过程，详见 STUN [RFC5389]。


## 6. 服务器行为

除非本文档另有规定，否则所有消息的准备、发送和处理程序均应遵循 STUN [RFC5389] 中关于 STUN 绑定使用方法的描述。

实现 NAT 行为发现（Behavior Discovery）的服务器应当在公共互联网中配置两个不同的 IP 地址。服务器启动时，应当为 UDP、TCP 和 TCP/TLS 传输协议各分配一对端口，使其可以在每个 IP 地址上使用相同的端口发送和接收数据报（通常使用通配绑定可实现此功能）。TCP 和 TCP/TLS必须使用不同的端口。

如果服务器无法在两个不同的 IP 地址上分配相同的端口，则不得在任何响应中包含 `OTHER-ADDRESS` 属性，并且必须对任何带有 `CHANGE-REQUEST` 属性的请求返回 420（未知属性）错误。

如果服务器只有一个 IP 地址，则不得使用 SRV 服务名称 `"stun-behavior"` 或 `"stun-behaviors"` 进行公布。

## 6.1 准备响应（Preparing the Response）

在执行所有身份验证和验证步骤后，如果 `Binding Request` 包含本文档定义的请求属性（`RESPONSE-PORT`、`CHANGE-REQUEST` 或 `PADDING`），服务器开始执行该使用方法的特定处理。如果 `Binding Request` 未包含本文档中的任何属性，则 `Binding Response` 仍必须包含 `OTHER-ADDRESS` 和 `RESPONSE-ORIGIN`。

服务器必须在 `Binding Response` 中包含 `MAPPED-ADDRESS` 和 `XOR-MAPPED-ADDRESS`。

如果请求包含 `CHANGE-REQUEST` 属性，而服务器没有可用的备用地址和端口，则服务器必须返回 420 错误响应。



### `Binding Response` 的源地址和端口

`Binding Response` 的源地址和端口取决于 `CHANGE-REQUEST` 属性的值及 `Binding Request` 接收时的地址和端口，如下表所示：

| 标志                | 源 IP 地址 | 源端口  | `OTHER-ADDRESS` |
|--------------------|----------|--------|----------------|
| 无                | Da       | Dp     | Ca:Cp         |
| 变更 IP（Change IP） | Ca       | Dp     | Ca:Cp         |
| 变更端口（Change Port） | Da       | Cp     | Ca:Cp         |
| 同时变更 IP 和端口  | Ca       | Cp     | Ca:Cp         |

其中：
- `A1` 和 `A2`：服务器的两个 IP 地址
- `P1` 和 `P2`：服务器的两个端口
- `Da`：请求的目标 IP 地址（`A1` 或 `A2`）
- `Dp`：请求的目标端口（`P1` 或 `P2`）
- `Ca`：与 `Da` 相反的 IP 地址
- `Cp`：与 `Dp` 相反的端口

当 `CHANGE-REQUEST` 设置了不同的标志时：
- **仅变更端口**：响应的源 IP 地址为 `Da`，源端口为 `Cp`。
- **仅变更 IP**：响应的源 IP 地址为 `Ca`，源端口为 `Dp`。
- **同时变更 IP 和端口**：响应的源 IP 地址为 `Ca`，源端口为 `Cp`。
- **无变更**或**缺少 `CHANGE-REQUEST`**：响应的源 IP 地址为 `Da`，源端口为 `Dp`。



### 其他属性

- 服务器必须在 `Binding Response` 中添加 `RESPONSE-ORIGIN` 属性，包含用于发送 `Binding Response` 的源地址和端口。
- 如果服务器支持备用地址和端口，则必须在 `Binding Response` 中添加 `OTHER-ADDRESS` 属性，其值为 `Ca` 和 `Cp`，无论 `CHANGE-REQUEST` 的标志如何。
- 如果请求包含 `PADDING`，则 `Binding Response`必须包含 `PADDING`，其长度应当等于出站接口的 MTU，并向上取整到 4 字节的倍数。
- 如果请求同时包含 `PADDING` 和 `RESPONSE-PORT`，服务器必须返回 400 错误响应。



### 其他处理

- 如果服务器要求身份验证，则必须在响应中包含 `MESSAGE-INTEGRITY` 和相关属性。
- 如果 STUN 消息与应用流量复用，则必须包含 `FINGERPRINT`。
- `ALTERNATE-SERVER` 不得与本规范中的其他属性一起出现。
- 响应的目标地址为请求的源地址；如果 `RESPONSE-PORT` 存在，则发送到该端口，而不是请求的原始端口。

## 7. 新属性
本文档定义了 NAT 行为发现所需的几个 STUN 属性。这些属性仅用于绑定请求和绑定响应。CHANGE-REQUEST 最初在 RFC 3489 [RFC3489] 中定义，但在此重新定义，因为该文件已被 [RFC5389] 淘汰。

**必须理解的范围：**

- 0x0003: CHANGE-REQUEST
- 0x0026: PADDING
- 0x0027: RESPONSE-PORT
- 0x802b: RESPONSE-ORIGIN
- 0x802c: OTHER-ADDRESS
### 7.1. 传输地址的表示

当一个属性包含传输层 IP 地址和端口时，其格式与 `MAPPED-ADDRESS` 相同。同样，`XOR-` 相关属性的格式与 `XOR-MAPPED-ADDRESS` [RFC5389] 相同。



### 7.2. CHANGE-REQUEST

`CHANGE-REQUEST` 属性包含两个标志位，用于控制服务器发送响应时使用的 IP 地址和端口。这两个标志分别称为“更改 IP”（change IP）和“更改端口”（change port）标志。

- `CHANGE-REQUEST` 仅允许出现在 **绑定请求**（Binding Request）中。
- “更改 IP” 和 “更改端口” 标志有助于确定 NAT 设备的当前过滤行为。
- 这些标志指示服务器从 **备用的源 IP 地址** 和/或 **备用端口** 发送绑定响应（Binding Response）。
- `CHANGE-REQUEST` 在绑定请求中是可选的。

该属性长度为 32 位，其中仅使用了两个比特（A 和 B）：

```
 0                   1                   2                   3
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 A B 0|
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
```

各标志的含义如下：

- **A（更改 IP 标志）**  
  - 若为 `true`，则请求服务器使用 **与接收到绑定请求时不同的 IP 地址** 发送绑定响应。

- **B（更改端口标志）**  
  - 若为 `true`，则请求服务器使用 **与接收到绑定请求时不同的端口** 发送绑定响应。



### 7.3. RESPONSE-ORIGIN

`RESPONSE-ORIGIN` 由服务器插入，指示发送响应的 **源 IP 地址和端口**。  
该属性可用于检测 **双重 NAT（Double NAT）** 配置，且 **仅出现在绑定响应（Binding Response）中**。



### 7.4. OTHER-ADDRESS

`OTHER-ADDRESS` 属性用于 **绑定响应**（Binding Response），其作用是：

- 告知客户端 **如果请求了 "更改 IP" 和 "更改端口"**，那么服务器将会使用的 **源 IP 地址和端口**。
- 仅当服务器 **拥有第二个 IP 地址** 时，才能在绑定响应中插入 `OTHER-ADDRESS`。

此外：

- `OTHER-ADDRESS` 采用与 `CHANGED-ADDRESS`（定义于 [RFC3489]）相同的属性编号。
- 它只是 `CHANGED-ADDRESS` 的 **新名称**，语义未变。
- 该属性的重命名是为了更清晰地表达其功能。

数据格式与 `MAPPED-ADDRESS` 一样

### 7.5. RESPONSE-PORT
`RESPONSE-PORT` 属性包含一个端口号，主要功能如下：

- 它可出现在 **绑定请求（Binding Request）** 中，指示 **绑定响应应发送到的端口**。
- 如果服务器支持 `RESPONSE-PORT`，则：
  - **绑定响应必须发送到** 绑定请求的 **源 IP 地址** 和 `RESPONSE-PORT` 指定的端口。
- `RESPONSE-PORT` 适用于某些测试（例如 **第 4.6 节** 的测试）。
- 如果 `RESPONSE-PORT` 未出现在请求中，服务器会将响应发送到 **绑定请求的源 IP 地址和端口**。

限制：

- 服务器 **不得** 处理同时包含 `RESPONSE-PORT` 和 `PADDING` 属性的请求。
- `RESPONSE-PORT` 在绑定请求中是 **可选的**，服务器的支持也是 **可选的**。

**数据格式：**

- `RESPONSE-PORT` 是一个 **16 位无符号整数（网络字节序）**，后跟 **2 字节填充**。
- 可接受的值范围：**0 - 65536**。


### 7.6. PADDING

`PADDING` 属性用于 **填充整个 STUN 消息**，以迫使其 **被拆分成 IP 片段**（UDP 分片）。  

`PADDING` 的特点：

- 它是一个 **自由格式的字符串**，其具体内容 **无关紧要**。
- 可用于 **绑定请求（Binding Request）和绑定响应（Binding Response）**。

约束条件：

- `PADDING` 的长度 **不得超过** 使 **整个 IP 数据报** 达到 **64K** 的长度。
- `PADDING` 的长度 **应当与发送接口的 MTU 相等**，并且 **向上取整为 4 字节的倍数**。
- 由于 STUN 消息使用 `PADDING` 主要是 **测试 UDP 分片行为**，因此它 **不受 STUN 消息应小于路径 MTU 的一般规则限制**。

